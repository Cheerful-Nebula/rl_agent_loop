# Generated by qwen2.5-coder (Iter 6) on 2025-12-12 22:18:35
import numpy as np

import numpy as np

def calculate_reward(observation, original_reward, terminated, truncated, info):
    """
    Args:
        observation (np.array): State vector (LunarLander has 8 values).
        original_reward (float): Reward from the env.
        terminated (bool): Crash or Landed.
        truncated (bool): Timeout.
        info (dict): Diagnostic info.
    """
    
    # Extract observations
    x_position, y_position, vx_velocity, vy_velocity, angle, angular_velocity, left_leg_contact, right_leg_contact = observation
    
    # Constants for reward shaping
    CRASH_PENALTY = -50.0  # Reduced to make crashes less punishing
    STABILITY_REWARD = 20.0  # Increased slightly to encourage smaller vertical velocities and tilt angles
    ENGINE_USAGE_REWARD = 1.5  # Slightly increased to encourage some engine usage
    OSCILLATION_PENALTY = -2.0  # Reduced to allow for some oscillation without being overly punitive
    UNCONTROLLED_VEL_PENALTY = -1.0  # Reduced to discourage prolonged use of engines more mildly

    novelty_bonus = 0.5 * np.abs(original_reward)  # Novelty bonus based on the absolute value of the original reward

    # Calculate the new reward based on custom logic
    shaped_reward = original_reward + novelty_bonus

    if terminated:
        # Penalize crashes
        if not truncated and not (left_leg_contact or right_leg_contact):
            shaped_reward += CRASH_PENALTY

    # Penalty for excessive oscillation in vertical velocity
    if np.abs(vy_velocity) > 0.15:
        shaped_reward += OSCILLATION_PENALTY

    # Reward for achieving controlled landings (small vertical velocity and tilt angle)
    if np.abs(vy_velocity) < 0.03 and np.abs(angle) < 0.05:
        shaped_reward += STABILITY_REWARD

    # Encourage engine usage
    main_engine_on = info.get('engine_on', False)
    side_engine_on = info.get('side_engine_on', False)
    if main_engine_on or side_engine_on:
        shaped_reward += ENGINE_USAGE_REWARD

    # Penalty for prolonged use of either engine to avoid excessive control jitter and potential instability
    if 'main_engine_time' in info:
        main_engine_time = info['main_engine_time']
        if main_engine_time > 5:  # Reduced threshold
            shaped_reward += UNCONTROLLED_VEL_PENALTY

    if 'side_engine_time' in info:
        side_engine_time = info['side_engine_time']
        if side_engine_time > 5:  # Reduced threshold
            shaped_reward += UNCONTROLLED_VEL_PENALTY

    return shaped_reward